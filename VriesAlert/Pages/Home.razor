@page "/"
@using VriesAlert.Services
@using VriesAlert.Models
@inject GeolocationService GeoService
@inject WeatherService WeatherService
@inject NotificationService NotifService
@inject GeocodingService GeocodingService
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>VriesAlert</PageTitle>

<div class="weather-container @(IsFreezing ? "freezing" : "safe")">
    <div class="main-display">
        @if (IsLoading && !CurrentTemp.HasValue)
        {
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
            <p class="mt-3 text-light">@StatusMessage</p>
        }
        else if (CurrentTemp.HasValue)
        {
            <div class="icon bounce-in">
                @CurrentWeatherIcon
            </div>
            
            <h1 class="display-1 fw-bold text-light mb-0">@CurrentTemp?.ToString("0.0")¬∞C</h1>
            <h3 class="h4 text-light mb-3 opacity-75">üìç @CurrentPlaceName</h3>

            <p class="lead text-light">
                @(IsFreezing ? "Het vriest! Pas op." : "Geen vorst gedetecteerd.")
            </p>
            <p class="small text-light opacity-75">Laatste check: @LastUpdated.ToString("HH:mm")</p>
            
            @if(IsLoading) 
            {
                <small class="text-light spinner-grow spinner-grow-sm"></small>
            }
        }
        else
        {
            <p class="text-light">Geen data beschikbaar. @StatusMessage</p>
            <button class="btn btn-light btn-lg mt-3" @onclick="StartMonitoring">Start</button>
        }
    </div>

    <!-- Map Container -->
    <div class="map-wrapper container mb-3">
        <div id="map" style="height: 200px; width: 100%; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
    </div>

    <div class="controls-container container">
        @if (NotificationPermission != "granted")
        {
            <div class="alert alert-warning d-flex align-items-center justify-content-between p-3 shadow-sm" role="alert">
                <span>üîî Ontvang meldingen bij vorst.</span>
                <button class="btn btn-sm btn-primary" @onclick="RequestNotifications">Activeer</button>
            </div>
        }

        <div class="logs-card card mt-3 shadow-sm">
            <div class="card-header bg-white fw-bold">
                Logboek
            </div>
            <ul class="list-group list-group-flush small">
                @if (Logs.Any())
                {
                    @foreach (var log in Logs.Take(5))
                    {
                        <li class="list-group-item">@log</li>
                    }
                }
                else
                {
                    <li class="list-group-item text-muted fst-italic">Nog geen checks uitgevoerd.</li>
                }
            </ul>
        </div>
        
        <div class="text-center mt-4">
             <button class="btn btn-outline-light btn-sm opacity-50" @onclick="CheckWeather">Handmatige Check</button>
        </div>
    </div>
</div>

@code {
    private double? CurrentTemp;
    private int CurrentWeatherCode;
    private string CurrentWeatherIcon => WeatherIconHelper.GetIcon(CurrentWeatherCode);
    private string CurrentPlaceName = "Locatie bepalen...";
    private bool IsFreezing => CurrentTemp.HasValue && CurrentTemp.Value < 0;
    private bool IsLoading = false;
    private string StatusMessage = "Klaar om te starten";
    private DateTime LastUpdated;
    private string NotificationPermission = "default";
    private List<string> Logs = new();
    private PeriodicTimer? _timer;
    private CancellationTokenSource _cts = new();
    private bool _mapInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        try {
            NotificationPermission = await NotifService.GetPermissionStatus();
        } catch { /* ignore JS interop errors during prerender */ }
        
        await StartMonitoring();
    }

    private async Task RequestNotifications()
    {
        await NotifService.RequestPermission();
        NotificationPermission = await NotifService.GetPermissionStatus();
    }

    private async Task StartMonitoring()
    {
        if (_timer != null) return;

        IsLoading = true;
        StatusMessage = "Initialiseren...";
        
        // Start periodic check every 15 minutes
        _timer = new PeriodicTimer(TimeSpan.FromMinutes(15));
        
        // Fire and forget the timer loop
        _ = RunTimer();
        
        // Do an immediate check
        await CheckWeather();
    }

    private async Task RunTimer()
    {
        try 
        {
            while (await _timer!.WaitForNextTickAsync(_cts.Token))
            {
                await CheckWeather();
            }
        }
        catch (OperationCanceledException) { }
    }

    private async Task CheckWeather()
    {
        try
        {
            IsLoading = true;
            StateHasChanged();

            StatusMessage = "Locatie bepalen...";
            var location = await GeoService.GetCurrentPosition();
            
            // Parallel execution for faster UI
            var weatherTask = WeatherService.GetCurrentTemperature(location.Latitude, location.Longitude);
            var placeTask = GeocodingService.GetPlaceName(location.Latitude, location.Longitude);

            await Task.WhenAll(weatherTask, placeTask);

            var weather = await weatherTask;
            CurrentPlaceName = await placeTask;

            if (weather?.Current != null)
            {
                CurrentTemp = weather.Current.Temperature2m;
                CurrentWeatherCode = weather.Current.WeatherCode;
                LastUpdated = DateTime.Now;
                
                string logMsg = $"{LastUpdated:HH:mm} - {CurrentTemp}¬∞C {CurrentWeatherIcon} in {CurrentPlaceName}";
                Logs.Insert(0, logMsg);
                
                if (IsFreezing)
                {
                    await NotifService.ShowNotification("VriesAlert! ‚ùÑÔ∏è", $"Het is {CurrentTemp}¬∞C in {CurrentPlaceName}! Pas op.");
                }

                await UpdateMap(location.Latitude, location.Longitude);
            }
        }
        catch (Exception ex)
        {
            // Simplified error logging
            string msg = ex.Message.Length > 30 ? ex.Message.Substring(0, 30) + "..." : ex.Message;
            Logs.Insert(0, $"{DateTime.Now:HH:mm} - Fout: {msg}");
            StatusMessage = "Fout opgetreden.";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task UpdateMap(double lat, double lon)
    {
        try
        {
            if (!_mapInitialized)
            {
                await JSRuntime.InvokeVoidAsync("window.vriesAlert.initializeMap", "map", lat, lon);
                _mapInitialized = true;
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("window.vriesAlert.updateMapPosition", lat, lon);
            }
        }
        catch 
        {
            // Map errors shouldn't crash the app
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _timer?.Dispose();
    }
}
